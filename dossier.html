<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dossier de Travail - E-Factu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Dossier Screen -->
    <div id="dossier-screen" class="p-8 md:p-12">
        <h2 id="dossier-title" class="text-2xl font-bold text-center mb-2">Dossier de Travail</h2>
        <p id="dossier-subtitle" class="text-center text-gray-500 mb-8">Cas d'usage identifiés et actions à mener</p>

        <!-- Client Info -->
        <div id="client-info" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Informations Client</h3>
            <div id="client-details" class="grid md:grid-cols-2 gap-4">
                <!-- Client details will be loaded here -->
            </div>
        </div>

        <!-- Accès rapide aux questionnaires - SECTION MISE EN AVANT -->
        <div id="questionnaire-access" class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg shadow-md mb-6 border-2 border-blue-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-blue-800 flex items-center">
                    <i class="fas fa-clipboard-list mr-3 text-blue-600"></i>
                    Accès aux questionnaires
                </h3>
                <span class="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">
                    <i class="fas fa-star mr-1"></i> Accès rapide
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-4">
                Complétez les questionnaires Vente et Achat pour identifier les cas d'usage de la réforme facture électronique.
            </p>
            <div class="flex flex-wrap gap-4">
                <button onclick="returnToWizard('vente')" class="flex-1 min-w-48 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
                    <i class="fas fa-arrow-up mr-3 text-xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Questionnaire Ventes</div>
                        <div class="text-xs opacity-90" id="vente-progress-badge">Chargement...</div>
                    </div>
                </button>
                <button onclick="returnToWizard('achat')" class="flex-1 min-w-48 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold py-4 px-6 rounded-xl shadow-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
                    <i class="fas fa-arrow-down mr-3 text-xl"></i>
                    <div class="text-left">
                        <div class="font-bold">Questionnaire Achats</div>
                        <div class="text-xs opacity-90" id="achat-progress-badge">Chargement...</div>
                    </div>
                </button>
            </div>
        </div>

        <!-- Analysis Selection -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Analyses Disponibles</h3>
            <div id="analysis-buttons" class="flex flex-wrap gap-4">
                <!-- Analysis buttons will be loaded here -->
            </div>
        </div>

        <!-- Analysis Results -->
        <div id="analysis-results" class="bg-white p-6 rounded-lg shadow-md mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">
                    Résultats de l'analyse<span id="analysis-type-title" class="text-lg font-semibold text-gray-800 ml-2"></span>
                </h3>
                <span id="analysis-type-badge" class="bg-blue-100 text-blue-800 text-sm font-medium px-2 py-1 rounded"></span>
            </div>
            
            <!-- Information banner -->
            <div id="analysis-info-banner" class="mb-6 p-4 rounded-lg border-l-4">
                <!-- Content will be dynamically populated -->
            </div>
            
            <div id="cases-container" class="space-y-4">
                <!-- Identified cases will be loaded here -->
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-between items-center">
            <div class="flex space-x-4">
                <button onclick="window.location.href='client-list.html'" class="text-gray-600 hover:text-gray-900 font-medium">
                    <i class="fas fa-chevron-left mr-2"></i> Retour à la liste
                </button>
                <div class="relative">
                    <button onclick="toggleWizardMenu()" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 flex items-center">
                        <i class="fas fa-question-circle mr-2"></i> Voir le questionnaire
                        <i class="fas fa-chevron-down ml-2"></i>
                    </button>
                    <div id="wizard-menu" class="hidden absolute top-full left-0 mt-2 bg-white border border-gray-300 rounded-lg shadow-lg z-50 min-w-48">
                        <button onclick="returnToWizard('vente')" class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-200 last:border-b-0 rounded-t-lg">
                            <i class="fas fa-arrow-up text-green-600 mr-2"></i>
                            Questionnaire Ventes
                        </button>
                        <button onclick="returnToWizard('achat')" class="w-full text-left px-4 py-3 hover:bg-blue-50 border-b border-gray-200 last:border-b-0 rounded-b-lg">
                            <i class="fas fa-arrow-down text-red-600 mr-2"></i>
                            Questionnaire Achats
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex space-x-4">
                <button onclick="generateReports()" id="generate-reports-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 disabled:bg-gray-400">
                    <i class="fas fa-file-alt mr-2"></i> Générer les rapports
                </button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentClient = null;
        let currentAnalysis = null;
        let currentAnalysisType = null;

                 // Initialize dossier
         function initializeDossier() {
             const urlParams = new URLSearchParams(window.location.search);
             const clientId = urlParams.get('client');
             
             if (!clientId) {
                 window.location.href = 'client-list.html';
                 return;
             }
             
             // Load client data (without refreshing display yet)
             reloadClientData(clientId, false);
             
             // Check if we have wizard answers to process
             const answersParam = urlParams.get('answers');
             const typeParam = urlParams.get('type');
             
             if (answersParam && typeParam) {
                 try {
                     const wizardAnswers = JSON.parse(answersParam);
                     processWizardAnswers(typeParam, wizardAnswers);
                 } catch (e) {
                     console.error('Erreur lors du traitement des réponses:', e);
                 }
             }
             
             // Also check for saved answers in localStorage
             processSavedWizardAnswers();
             
            // Now refresh display
            displayClientInfo();
            displayAnalysisOptions();
            updateQuestionnaireAccessBadges();
            
            // Auto-display analysis results if available
            autoDisplayAnalysisResults();
        }
        
        // Update the questionnaire access badges with progress info
        function updateQuestionnaireAccessBadges() {
            const venteStats = getQuestionnaireStats('vente');
            const achatStats = getQuestionnaireStats('achat');
            
            const venteBadge = document.getElementById('vente-progress-badge');
            const achatBadge = document.getElementById('achat-progress-badge');
            
            if (venteBadge) {
                const venteComplete = venteStats.answered >= venteStats.total;
                if (venteComplete) {
                    venteBadge.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Complet (${venteStats.answered}/${venteStats.total})`;
                } else if (venteStats.answered > 0) {
                    venteBadge.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${venteStats.answered}/${venteStats.total} - À compléter`;
                } else {
                    venteBadge.innerHTML = `<i class="fas fa-play-circle mr-1"></i> À commencer (0/${venteStats.total})`;
                }
            }
            
            if (achatBadge) {
                const achatComplete = achatStats.answered >= achatStats.total;
                if (achatComplete) {
                    achatBadge.innerHTML = `<i class="fas fa-check-circle mr-1"></i> Complet (${achatStats.answered}/${achatStats.total})`;
                } else if (achatStats.answered > 0) {
                    achatBadge.innerHTML = `<i class="fas fa-exclamation-circle mr-1"></i> ${achatStats.answered}/${achatStats.total} - À compléter`;
                } else {
                    achatBadge.innerHTML = `<i class="fas fa-play-circle mr-1"></i> À commencer (0/${achatStats.total})`;
                }
            }
        }
         
         // Reload client data from localStorage
         function reloadClientData(clientId, refreshDisplay = true) {
             const clients = JSON.parse(localStorage.getItem('clients') || '[]');
             const updatedClient = clients.find(c => c.id === clientId);
             
             if (!updatedClient) {
                 window.location.href = 'client-list.html';
                 return;
             }
             
             // Update currentClient with latest data
             currentClient = updatedClient;
             
            // Refresh display if requested
            if (refreshDisplay) {
                displayClientInfo();
                displayAnalysisOptions();
                updateQuestionnaireAccessBadges();
                
                // If an analysis is currently displayed, refresh it
                if (currentAnalysisType && currentClient.analyses && currentClient.analyses[currentAnalysisType]) {
                    showAnalysis(currentAnalysisType);
                }
            }
        }

                 // Process wizard answers and save to client analyses
         function processWizardAnswers(wizardType, answers) {
             if (!currentClient.analyses) {
                 currentClient.analyses = {};
             }
             
             // Get applicable cases based on answers
             const applicableCases = getApplicableCasesForWizard(wizardType, answers);
             
             // Save analysis data
             currentClient.analyses[wizardType] = {
                 date: new Date().toISOString(),
                 answers: answers,
                 identifiedCases: Array.from(applicableCases),
                 completed: true
             };
             
             // Update client in localStorage
             const clients = JSON.parse(localStorage.getItem('clients') || '[]');
             const clientIndex = clients.findIndex(c => c.id === currentClient.id);
             if (clientIndex !== -1) {
                 clients[clientIndex] = currentClient;
                 localStorage.setItem('clients', JSON.stringify(clients));
             }
             
             console.log(`Analyse ${wizardType} traitée pour ${currentClient.name}:`, currentClient.analyses[wizardType]);
             
             // Refresh the display to show the new analysis
             displayAnalysisOptions();
         }

        // Process saved wizard answers from localStorage
        function processSavedWizardAnswers() {
            if (!currentClient.analyses) {
                currentClient.analyses = {};
            }
            
            // Check for saved answers for both vente and achat
            ['vente', 'achat'].forEach(wizardType => {
                const key = `wizard_${currentClient.name}_${wizardType}`;
                const savedAnswers = localStorage.getItem(key);
                
                if (savedAnswers && !currentClient.analyses[wizardType]) {
                    try {
                        const answers = JSON.parse(savedAnswers);
                        processWizardAnswers(wizardType, answers);
                    } catch (e) {
                        console.error(`Erreur lors du traitement des réponses sauvegardées pour ${wizardType}:`, e);
                    }
                }
            });
        }

        // Function to get applicable cases based on wizard answers (from Florian.html)
        function getApplicableCasesForWizard(wizardType, currentAnswers) {
            const applicable = new Set();
            if (currentAnswers) {
                questions[wizardType].forEach((q, index) => {
                    if (currentAnswers[index] === 'yes') {
                        q.uc.forEach(ucId => applicable.add(ucId));
                        
                        // Handle conditional questions
                        if (q.conditional) {
                            const conditionalAnswer = currentAnswers[`conditional_${index}`];
                            
                            // Question 4 (Affacturage) - index 3
                            if (index === 3 && conditionalAnswer === 'after') {
                                // Add specific case for affacturage after emission
                                applicable.add('10_after_emission');
                            }
                            
                            // Question 6 (Tiers émission factures) - index 5
                            if (index === 5 && conditionalAnswer === 'yes') {
                                // Add specific case for tiers managing both emission and payment
                                applicable.add('17b_19a_payment_management');
                            }
                            
                            // Question 9 (Co-traitance) - index 8
                            if (index === 8 && conditionalAnswer === 'yes') {
                                // Add specific case for mandataire in co-traitance
                                applicable.add('14_mandataire');
                            }
                        }
                    }
                });
            }
            return applicable;
        }

        // Questions database from Florian.html
        const questions = {
            vente: [
                { q: "Votre client émet-t-il des factures pour des biens/services qui ont déjà été payés (ex: paiement à la commande) ?", uc: ['2'] },
                { q: "Votre client demande-t-il des acomptes à ses clients avant la livraison finale ou la fin de la prestation ?", uc: ['20_21'] },
                { q: "Votre client propose-t-il un escompte pour paiement anticipé ?", uc: ['22a', '22b'] },
                { q: "Votre client cède-t-il ses créances à une société d'affacturage (factor) ?", uc: ['8', '10'], conditional: true },
                { q: "Le paiement des factures de votre client est-il parfois versé à un tiers qui n'est pas un factor (ex: distributeur, dépositaire) ?", uc: ['9'] },
                { q: "Un tiers (comme une marketplace ou un distributeur) émet-t-il les factures au nom et pour le compte de votre client ?", uc: ['17b', '19a'], conditional: true },
                { q: "Votre client vend-t-il ses produits/services via une place de marché (marketplace) qui encaisse le paiement ?", uc: ['17a'] },
                { q: "Votre client agit-t-il en tant que sous-traitant pour un autre professionnel (le donneur d'ordre) ?", uc: ['13'] },
                { q: "Votre client fait-t-il partie d'un groupement d'entreprises (co-traitance) pour réaliser une prestation ?", uc: ['14'], conditional: true },
                { q: "Votre client facture-t-il plusieurs de ses bons de commande ou de livraison sur une seule et même facture ?", uc: ['1'] },
                { q: "Votre client émet-t-il des factures de débours (remboursement de dépenses payées pour le compte d'un tiers) ?", uc: ['16'] },
                { q: "Votre client émet-t-il des notes de débit ?", uc: ['18'] },
                { q: "Votre client émet-il des factures où le payeur est différent du client (ex: assurance, mutuelle, organisme public) ?", uc: ['3'] },
                { q: "Émettez-vous des factures avec prise en charge partielle par un tiers (subvention, assurance, aide publique) ?", uc: ['4b'] },
                { q: "Avez-vous des clients qui émettent eux-mêmes les factures pour votre compte (auto-facturation) ?", uc: ['23'] },
                { q: "Recevez-vous des arrhes (sommes versées à la commande avec possibilité d'annulation) de vos clients ?", uc: ['24'] },
                { q: "Votre client émet-t-il ou accepte-t-il des bons ou cartes cadeaux ?", uc: ['25'] },
                { q: "Les factures de votre client (émises ou reçues) incluent-elles des clauses de réserve contractuelle (ex: clause de réserve de propriété) ?", uc: ['26'] },
                { q: "Les factures de votre client (émises ou reçues) combinent-elles une opération principale et une ou plusieurs opérations accessoires (ex: vente de biens + transport) ?", uc: ['31'] },
                { q: "Votre client émet-t-il ou reçoit-t-il des factures pour des paiements mensuels récurrents (ex: abonnements, loyers) ?", uc: ['32'] },
                { q: "Votre client gère-t-il des encaissements partiels ou des annulations d'encaissement ?", uc: ['34'] },
                { q: "Votre client fait-t-il partie d'un groupe TVA (régime de l'assujetti unique) ?", uc: ['29'] },
                { q: "L'activité de votre client relève-t-elle d'un régime de TVA sur la marge (ex: agences de voyages, biens d'occasion, œuvres d'art) ?", uc: ['33'] },
                { q: "Votre client, qui vend habituellement à des particuliers (B2C), doit-t-il parfois émettre une facture à un professionnel qui le demande après l'achat (ex: restaurateur, commerçant) ?", uc: ['30'] },
                { q: "Votre client traite-t-il des opérations soumises au secret professionnel ou des échanges de données sensibles ?", uc: ['36'] },
                { q: "Votre client émet-t-il ou reçoit-t-il des notes d'auteur ?", uc: ['35'] },
                { q: "Votre client est-il Gérant ou associé d'une Société en Participation (SEP) ou d'un groupement momentané d'entreprises (GME) nécessitant une gestion distincte des factures d'achat et de vente pour le compte de cette entité ?", uc: ['37'] },
                { q: "Votre client émet-il des factures pour des articles composites (kits, packs) ou des regroupements (par commande/livraison) nécessitant des lignes de détail, d'information ou de sous-totaux ?", uc: ['38'] },
                { q: "Votre client (Vendeur principal) regroupe-t-il sur une seule facture ses propres prestations et celles d'autres vendeurs tiers (Vendeurs secondaires) pour un même acheteur ?", uc: ['39'] },
                { q: "Votre client pratique-t-il la compensation (clearing/netting) avec ses partenaires, en déduisant le montant de ses factures de vente du paiement de ses factures d'achat ?", uc: ['40'] },
                { q: "Votre client réalise-t-il des transactions via des sociétés de Barter (troc interentreprises), impliquant un paiement partiel en numéraire (souvent la TVA) et une compensation en crédits pour le solde ?", uc: ['41'] },
                { q: "Votre client commerçant réalise-t-il des ventes à des particuliers non-résidents (touristes) donnant lieu à une détaxe (remboursement de TVA) ?", uc: ['42'] }
            ],
            achat: [
                { q: "Votre client reçoit-t-il des factures de la part de ses fournisseurs en auto-facturation (c'est-à-dire que votre client crée lui-même la facture de son fournisseur) ?", uc: ['19b'] },
                { q: "Votre client verse-t-il des acomptes à ses fournisseurs ?", uc: ['20_21'] },
                { q: "Un tiers (ex: centre de services partagés, cabinet d'expertise comptable) gère-t-il la réception et le traitement des factures d'achat pour votre client ?", uc: ['11', '12'] },
                { q: "Les collaborateurs de votre client engagent-ils des frais professionnels (ex: hôtel, restaurant, transport) qui sont directement facturés à l'entreprise ?", uc: ['5'] },
                { q: "Les collaborateurs de votre client engagent-ils des frais professionnels pour lesquels ils ne reçoivent pas de facture au nom de l'entreprise (ex: simples tickets de caisse) ?", uc: ['6'] },
                { q: "Votre client utilise-t-il des cartes d'achat professionnelles (cartes logées) pour régler ses fournisseurs ?", uc: ['7'] },
                { q: "Votre client fait-t-il appel à des sous-traitants qu'il est parfois amené à payer directement, à la place du donneur d'ordre ?", uc: ['13'] },
                { q: "Votre client agit-t-il en tant que mandataire dans un groupement d'entreprises (co-traitance) ?", uc: ['14'] },
                { q: "Votre client reçoit-t-il des factures de fournisseurs qui ont recours à l'affacturage ?", uc: ['8', '10'] },
                { q: "Le paiement des factures de votre client est-il effectué par une autre société du groupe (centrale de paiement) ?", uc: ['3'] },
                { q: "Votre client reçoit-t-il des factures dont une partie est prise en charge par un tiers (ex: subvention, assurance) ?", uc: ['4'] },
                { q: "Votre client reçoit-t-il des factures regroupant plusieurs de ses bons de commande ou de livraison ?", uc: ['1'] },
                { q: "Votre client reçoit-t-il des factures de débours ?", uc: ['16'] },
                { q: "Les factures de votre client (émises ou reçues) incluent-elles des clauses de réserve contractuelle (ex: clause de réserve de propriété) ?", uc: ['26'] },
                { q: "Votre client traite-t-il des opérations soumises au secret professionnel ou des échanges de données sensibles ?", uc: ['36'] },
                { q: "Votre client émet-t-il ou reçoit-t-il des notes d'auteur ?", uc: ['35'] },
                { q: "Votre client est-il Gérant ou associé d'une Société en Participation (SEP) ou d'un groupement momentané d'entreprises (GME) nécessitant une gestion distincte des factures d'achat et de vente pour le compte de cette entité ?", uc: ['37'] },
                { q: "Votre client pratique-t-il la compensation (clearing/netting) avec ses partenaires, en déduisant le montant de ses factures de vente du paiement de ses factures d'achat ?", uc: ['40'] },
                { q: "Votre client réalise-t-il des transactions via des sociétés de Barter (troc interentreprises), impliquant un paiement partiel en numéraire (souvent la TVA) et une compensation en crédits pour le solde ?", uc: ['41'] }
            ]
        };

        // Use cases database from Florian.html
        const useCases = {
            '1': { title: "Cas n°1 : Multi-commande / Multi-livraison", summary: "La facture regroupe plusieurs commandes ou plusieurs livraisons distinctes.", risk: "Complexité de rapprochement", impact: "Lettrage comptable, suivi des livraisons", action: "Valider la capacité du logiciel de facturation à gérer le format étendu (EXTENDED-CTC-FR).", checklist: ["Le logiciel de facturation gère-t-il le profil EXTENDED-CTC-FR ?", "Le rapprochement avec les bons de commande/livraison est-il automatisé ?"], defaultCriticality: 'medium' },
            '2': { title: "Cas n°2 : Facture déjà payée", summary: "La facture est émise alors que le paiement a déjà été effectué.", risk: "Double comptabilisation du paiement", impact: "Trésorerie, lettrage, déclaration de TVA (si due à l'encaissement)", action: "S'assurer que le statut 'Encaissée' est transmis immédiatement.", checklist: ["Le processus de facturation identifie-t-il bien les ventes déjà réglées ?", "Le statut 'Encaissée' est-il envoyé automatiquement pour ces factures ?"], defaultCriticality: 'medium' },
            '3': { title: "Cas n°3 : Facture à payer par un tiers PAYEUR connu au moment de la facturation", summary: "Des factures sont émises à un client mais doivent être payées par un tiers identifié (assurance, mutuelle, organisme public, etc.).", risk: "Erreur de paiement, rejet de la facture par le tiers, retard de paiement", impact: "Trésorerie, lettrage comptable, relation client", action: "S'assurer que les coordonnées et références du tiers payeur sont correctement intégrées dans la facture électronique et que le processus de validation par le tiers est en place.", checklist: ["Les factures mentionnent-elles clairement l'identité du tiers payeur ?"], defaultCriticality: 'high' },
            '4': { title: "Cas n°4 : Prise en charge partielle par un tiers", summary: "La facture est payée en partie par le client et en partie par un tiers.", risk: "Complexité du suivi des paiements", impact: "Lettrage partiel, trésorerie", action: "Définir un processus clair pour le suivi des deux paiements attendus.", checklist: ["Le logiciel comptable gère-t-il les paiements partiels sur une même facture ?", "Le processus de déclaration des encaissements partiels est-il défini ?"], defaultCriticality: 'medium' },
            '4b': { title: "Cas n°4 : Facture à payer par l'acheteur et prise en charge partiellement par un tiers", summary: "Une partie du montant de la facture est prise en charge par un tiers (subvention, assurance, aide) tandis que le solde reste à la charge du client.", risk: "Complexité du lettrage, erreur de ventilation TVA, double facturation", impact: "Suivi des encaissements, TVA, comptabilité auxiliaire", action: "Mettre en place un processus de facturation permettant d'identifier clairement la répartition des paiements et assurer la traçabilité des encaissements partiels.", checklist: ["La ventilation entre la part client et la part tiers est-elle clairement identifiée ?", "Le processus de facturation permet-il de gérer deux payeurs distincts ?"], defaultCriticality: 'high' },
            '5': { title: "Cas n°5 : Frais payés par des collaborateurs (facture à l'entreprise)", summary: "Un collaborateur avance des frais pour lesquels une facture est émise au nom de l'entreprise.", risk: "Rapprochement note de frais / facture", impact: "Comptabilisation des charges, récupération de TVA", action: "Mettre en place un processus de rapprochement entre la note de frais et la facture électronique.", checklist: ["Le logiciel de notes de frais peut-t-il s'interfacer avec la comptabilité ?", "La facture électronique est-elle bien jointe à la note de frais pour justification ?"], defaultCriticality: 'medium' },
            '6': { title: "Cas n°6 : Frais payés par des collaborateurs sans facture adressée à l'entreprise (simple ticket de caisse)", summary: "Les collaborateurs engagent des dépenses professionnelles pour lesquelles ils ne disposent que de justificatifs simplifiés.", risk: "Non-déductibilité de la TVA, difficultés de justification des charges, risque fiscal.", impact: "Récupération de TVA, conformité fiscale, gestion des notes de frais.", action: "Mettre en place une procédure claire pour la gestion des justificatifs simplifiés.", checklist: ["Existe-t-il une politique claire pour les notes de frais et les justificatifs ?", "Les justificatifs sont-ils conformes aux exigences fiscales pour la déduction des charges ?"], defaultCriticality: 'high' },
            '7': { title: "Cas n°7 : Achat payé avec une carte logée (carte d'achat)", summary: "Les achats sont réalisés via une carte d'achat fournie par l'entreprise.", risk: "Rapprochement relevé de carte / factures", impact: "Comptabilisation des charges, TVA", action: "Automatiser le rapprochement entre les relevés de carte et les factures reçues.", checklist: ["Le rapprochement entre les transactions sur le relevé et les factures est-il systématique ?", "Comment sont gérées les transactions sans facture justificative ?"], defaultCriticality: 'medium' },
            '8': { title: "Cas n°8 : Affacturage (factor connu à la facturation)", summary: "Le client cède ses créances à une société d'affacturage.", risk: "Coordination avec le factor", impact: "Suivi du poste client, lettrage", action: "Valider que les factures contiennent les mentions et coordonnées bancaires du factor.", checklist: ["Le logiciel de facturation peut-t-il gérer plusieurs coordonnées bancaires par client ?", "Le processus de transmission des statuts au factor est-il défini ?"], defaultCriticality: 'medium' },
            '9': { title: "Cas n°9 : Facture à payer à un tiers (Distributeur/Dépositaire)", summary: "Le paiement doit être effectué à un tiers qui gère la relation commerciale.", risk: "Erreur de paiement", impact: "Lettrage, relations fournisseurs", action: "S'assurer que les coordonnées du tiers sont correctement gérées dans la base fournisseurs.", checklist: ["La base de données fournisseurs distingue-t-elle le fournisseur de l'ordre du bénéficiaire du paiement ?"], defaultCriticality: 'medium' },
            '10': { title: "Cas n°10 : Affacturage (factor inconnu à la facturation)", summary: "La cession de la créance a lieu après l'émission de la facture.", risk: "Risque de paiement au mauvais bénéficiaire", impact: "Trésorerie, lettrage", action: "Mettre en place un processus d'information du client via les statuts de cycle de vie.", checklist: ["Le client est-il équipé pour envoyer des statuts de changement de bénéficiaire ?", "Comment le client est-il informé de l'acceptation de la cession par le factor ?"], defaultCriticality: 'high' },
            '11': { title: "Cas n°11 : Facture traitée par un tiers pour l'acheteur", summary: "Un tiers (CSP, etc.) traite les factures pour le compte du client.", risk: "Délégation et responsabilité", impact: "Délais de traitement, validation des factures", action: "Formaliser le mandat de gestion et les droits d'accès à la PA.", checklist: ["Un mandat de gestion a-t-il été signé avec le tiers ?", "Le processus de validation des factures par le client est-il clair ?"], defaultCriticality: 'medium' },
            '12': { title: "Cas n°12 : Intermédiaire transparent agissant pour l'acheteur", summary: "Un intermédiaire gère les commandes et la validation des factures.", risk: "Double flux de facturation", impact: "Comptabilisation (facture principale + facture de commission)", action: "Distinguer et traiter les deux flux de factures (fournisseur -> client et intermédiaire -> client).", checklist: ["Le processus comptable distingue-t-il bien la facture principale de la facture de commission de l'intermédiaire ?"], defaultCriticality: 'medium' },
            '13': { title: "Cas n°13 : Sous-traitance avec paiement direct ou délégation de paiement", summary: "Le client est un donneur d'ordre faisant appel à des sous-traitants.", risk: "Complexité des flux (3 acteurs)", impact: "Suivi des paiements, TVA (autoliquidation)", action: "Cartographier précisément les flux de facturation et de paiement entre les trois parties.", checklist: ["Le contrat de sous-traitance prévoit-t-il la délégation de paiement ?", "Le traitement de l'autoliquidation de la TVA est-il maîtrisé ?"], defaultCriticality: 'high' },
            '14': { title: "Cas n°14 : Co-traitance B2B", summary: "Le client fait partie d'un groupement d'entreprises (co-traitance).", risk: "Coordination entre co-traitants", impact: "Facturation, suivi des paiements", action: "Clarifier le rôle du mandataire et le processus de validation des factures.", checklist: ["La convention de co-traitance est-elle claire sur les modalités de facturation ?", "Le rôle du mandataire dans la validation est-il formalisé ?"], defaultCriticality: 'medium' },
            '15': { title: "Cas n°15 : Commande et paiement par un tiers pour l'acheteur", summary: "Un tiers (ex: agence média) gère les commandes et paiements.", risk: "Transparence des flux", impact: "Comptabilisation des charges", action: "S'assurer que la facture finale est bien au nom du client et non du tiers.", checklist: ["Le client reçoit-t-il bien les factures originales des fournisseurs finaux ?", "Le mandat avec l'agent est-il clair sur la gestion de la facturation ?"], defaultCriticality: 'medium' },
            '16': { title: "Cas n°16 : Facture de débours pour remboursement de la facture de vente payée par le tiers", summary: "Une entreprise paie une facture pour le compte d'un tiers (son client) et la refacture ensuite à ce client.", risk: "Qualification erronée (débours vs. revente), risque fiscal sur la TVA.", impact: "TVA, conformité des factures, lettrage.", action: "S'assurer de la qualification correcte des débours (pas de TVA sur le débours refacturé) et de la bonne émission de la facture de débours avec les mentions spécifiques.", checklist: ["Le processus de refacturation des débours est-il conforme aux règles fiscales (article 267 du CGI) ?", "Les factures de débours incluent-elles les mentions obligatoires (référence à la facture originale, nature des débours) ?"], defaultCriticality: 'medium' },
            '17a': { title: "Cas n°17a : Vente via une marketplace (intermédiaire de paiement)", summary: "Le client vend sur une place de marché qui encaisse le paiement.", risk: "Rapprochement ventes / paiements", impact: "Trésorerie, comptabilisation des commissions", action: "Automatiser le rapprochement entre les ventes, les paiements reçus de la marketplace et les factures de commission.", checklist: ["Le client rapproche-t-il systématiquement les relevés de la marketplace avec ses ventes ?", "Les factures de commission sont-elles correctement comptabilisées ?"], defaultCriticality: 'medium' },
            '17b': { title: "Cas n°17b : Marketplace agissant sous mandat de facturation", summary: "La marketplace émet la facture au nom du vendeur.", risk: "Perte de contrôle sur la facturation", impact: "Conformité des factures, numérotation", action: "Vérifier la conformité du mandat de facturation et la bonne transmission des factures.", checklist: ["Le mandat de facturation a-t-il été validé juridiquement ?", "Le client a-t-il accès à toutes les factures émises pour son compte ?"], defaultCriticality: 'high' },
            '18': { title: "Cas n°18 : Gestion des notes de débit", summary: "Émission ou réception de notes de débit, qui sont des documents rectificatifs des factures.", risk: "Erreur de comptabilisation, non-conformité des flux de correction.", impact: "Comptabilité fournisseur/client, lettrage, e-invoicing.", action: "Mettre en place un processus de traitement des notes de débit conforme aux exigences de la facture électronique.", checklist: ["Le logiciel gère-t-il l'émission/réception des notes de débit électroniques ?", "Les notes de débit sont-elles correctement rattachées aux factures initiales ?"], defaultCriticality: 'medium' },
            '19a': { title: "Cas n°19a : Facture émise par un tiers sous mandat", summary: "Un tiers est mandaté pour créer et émettre les factures du client.", risk: "Responsabilité légale", impact: "Conformité des factures", action: "S'assurer de l'existence d'un mandat de facturation en bonne et due forme.", checklist: ["Le mandat de facturation est-il écrit et détaillé ?", "Comment le client contrôle-t-il les factures émises par le mandataire ?"], defaultCriticality: 'medium' },
            '19b': { title: "Cas n°19b : Auto-facturation", summary: "Le client (acheteur) émet lui-même les factures de son fournisseur.", risk: "Complexité du processus inversé", impact: "Numérotation des factures, gestion des statuts", action: "Valider le mandat d'auto-facturation et le processus de validation par le fournisseur.", checklist: ["Le mandat d'auto-facturation est-il en place ?", "Le fournisseur valide-t-il chaque facture émise pour son compte ?"], defaultCriticality: 'medium' },
            '20_21': { title: "Cas n°20 & 21 : Factures d'acompte et facture finale", summary: "Le processus de vente inclus des acomptes.", risk: "Gestion de la TVA sur acomptes", impact: "Exigibilité de la TVA, lettrage", action: "S'assurer que chaque acompte donne lieu à une facture et que la TVA est correctement gérée.", checklist: ["Une facture d'acompte est-elle émise pour chaque acompte reçu ?", "La facture finale fait-il correctement référence aux acomptes versés ?"], defaultCriticality: 'medium' },
            '22a': { title: "Cas n°22a : Escompte sur prestations de services (TVA à l'encaissement)", summary: "Le client accorde un escompte pour paiement anticipé.", risk: "Calcul de la TVA collectée", impact: "TVA, trésorerie", action: "Baser la déclaration de TVA sur le montant réellement encaissé.", checklist: ["Le logiciel comptable ajuste-t-il la TVA sur la base de l'encaissement réel en cas d'escompte ?"], defaultCriticality: 'medium' },
            '22b': { title: "Cas n°22b : Escompte sur livraisons de biens (TVA au débit)", summary: "Le client accorde un escompte pour paiement anticipé.", risk: "Correction de la TVA déclarée", impact: "TVA, comptabilité", action: "Mettre en place un processus d'émission d'avoir pour rectifier la base de TVA.", checklist: ["Un avoir est-il systématiquement émis en cas de paiement avec escompte ?", "L'avoir est-il correctement rattaché à la facture initiale ?"], defaultCriticality: 'medium' },
            '23': { title: "Cas n°23 : Auto-facturation B2B", summary: "Le client (acheteur) émet lui-même la facture au nom et pour le compte du fournisseur dans le cadre d'un mandat d'auto-facturation.", risk: "Perte de contrôle sur la facturation, erreurs de TVA", impact: "Responsabilité fiscale, déclaration TVA", action: "Vérifier la conformité du mandat d'auto-facturation, mettre en place un processus de validation et s'assurer de la bonne récupération des factures pour la comptabilité.", checklist: ["Le mandat d'auto-facturation est-il conforme aux exigences légales ?"], defaultCriticality: 'high' },
            '24': { title: "Cas n°24 : Gestion des arrhes", summary: "Des arrhes sont versées par les clients à la commande, avec possibilité d'annulation et perte des arrhes.", risk: "Erreur sur l'exigibilité de la TVA, non-conformité de la facturation, litiges en cas d'annulation", impact: "TVA, comptabilisation, gestion des annulations", action: "Définir une politique claire de facturation des arrhes et s'assurer de la conformité du traitement TVA selon la nature des opérations.", checklist: ["La distinction entre arrhes et acomptes est-elle claire dans vos processus ?", "Une facture d'arrhes est-elle systématiquement émise ?", "La TVA est-elle correctement traitée selon les règles d'exigibilité ?", "Le processus en cas d'annulation (conservation des arrhes) est-il formalisé ?", "Les arrhes sont-elles correctement déduites de la facture finale ?"], defaultCriticality: 'medium' },
            '25': { title: "Cas n°25 : Gestion des bons et des cartes cadeaux", summary: "Émission ou acceptation de bons et cartes cadeaux.", risk: "Erreur de TVA (bon à usage unique/multiple), complexité de la facturation.", impact: "TVA, comptabilisation des ventes/achats.", action: "Identifier si les bons/cartes cadeaux sont à usage unique ou multiple pour appliquer la TVA au bon moment.", checklist: ["Le client distingue-t-il les bons/cartes cadeaux à usage unique des bons/cartes cadeaux à usages multiples ?", "La TVA est-elle collectée au bon moment (émission du bon ou utilisation) ?"], defaultCriticality: 'medium' },
            '26': { title: "Cas n°26 : Factures avec clause de réserve contractuelle", summary: "Émission ou réception de factures incluant une clause de réserve de propriété ou autre clause contractuelle.", risk: "Non-conformité des mentions, risque juridique.", impact: "Validité juridique de la facture, gestion des litiges.", action: "S'assurer que les clauses contractuelles sont correctement intégrées dans les factures électroniques et qu'elles ne contreviennent pas aux exigences du format.", checklist: ["Les clauses contractuelles sont-elles compatibles avec le format de la facture électronique ?", "Les mentions légales sont-elles toujours présentes malgré la clause ?"], defaultCriticality: 'medium' },
            '27': { title: "Cas n°27 : Gestion des tickets de péage vendus à un assujetti", summary: "Facturation de tickets de péage à des professionnels.", risk: "Non-conformité des justificatifs de TVA, déductibilité.", impact: "Récupération de TVA, conformité fiscale.", action: "S'assurer que le client reçoit des factures conformes pour les péages afin de récupérer la TVA.", checklist: ["Le client reçoit-t-il des factures de péage avec toutes les mentions obligatoires pour la TVA ?", "Le processus de collecte de ces factures est-il efficace ?"], defaultCriticality: 'medium' },
            '28': { title: "Cas n°28 : Gestion des notes de restaurant émises par un VENDEUR assujetti établi en France", summary: "Facturation de notes de restaurant par un professionnel (pour des repas d'affaires, par exemple).", risk: "Non-conformité des justificatifs, déductibilité.", impact: "Récupération de TVA, déduction des charges, conformité fiscale.", action: "Vérifier que les notes de restaurant sont émises sous forme de facture électronique avec les mentions obligatoires pour la déductibilité.", checklist: ["Le client reçoit-t-il des factures de restaurant conformes pour la déductibilité ?", "Le processus de collecte de ces factures est-il efficace ?"], defaultCriticality: 'medium' },
            '29': { title: "Cas n°29 : Membre d'un assujetti unique (groupe TVA)", summary: "Le client fait partie d'un groupe TVA.", risk: "Erreur sur les mentions obligatoires", impact: "Conformité fiscale", action: "Vérifier que les factures mentionnent les identifiants du membre ET du groupe.", checklist: ["Le logiciel de facturation est-il paramétré pour inclure les deux identifiants (membre et groupe) ?"], defaultCriticality: 'medium' },
            '30': { title: "Cas n°30 : Facture B2B émise après une vente B2C", summary: "Une vente B2C est requalifiée en B2B a posteriori.", risk: "Double déclaration de TVA", impact: "TVA, e-reporting", action: "Utiliser le cadre de facturation spécifique 'TVA déjà collectée' (S7/B7/M7).", checklist: ["Le logiciel de facturation permet-t-il d'utiliser le cadre de facturation S7/B7/M7 ?", "Le processus pour isoler cette transaction du e-reporting B2C est-il en place ?"], defaultCriticality: 'high' },
            '31': { title: "Cas n°31 : Les factures << mixtes >> mentionnant une opération principale et une opération accessoire", summary: "Factures combinant une opération principale (ex: vente de biens) et une opération accessoire (ex: transport, installation).", risk: "Erreur de qualification TVA, e-reporting incorrect.", impact: "Déclaration de TVA, e-reporting.", action: "S'assurer que la qualification fiscale de l'opération principale et accessoire est correcte et que les montants sont bien distingués dans la facture électronique.", checklist: ["Les opérations principales et accessoires sont-elles clairement identifiées ?", "La TVA est-elle appliquée correctement à chaque composante ?"], defaultCriticality: 'medium' },
            '32': { title: "Cas n°32 : Les paiements mensuels", summary: "Gestion des factures pour des services ou biens facturés mensuellement (abonnements, loyers, etc.).", risk: "Non-conformité sur la date d'émission/d'exigibilité, e-reporting.", impact: "Exigibilité de la TVA, e-reporting.", action: "Vérifier que les factures mensuelles sont émises et transmises dans les délais, et que le e-reporting est conforme pour ces flux récurrents.", checklist: ["Les factures mensuelles sont-elles émises et transmises dans les délais légaux ?", "Le e-reporting des paiements mensuels est-il correctement configuré ?"], defaultCriticality: 'medium' },
            '33': { title: "Cas n°33 : Opérations soumises au régime de la marge bénéficiaire", summary: "L'activité du client relève de la TVA sur la marge.", risk: "Écart avec le pré-remplissage TVA", impact: "Déclaration de TVA", action: "Documenter le calcul de la marge pour justifier l'écart avec les données du e-invoicing.", checklist: ["Le calcul de la TVA sur la marge est-il documenté et traçable pour chaque opération ?", "Le client est-il préparé à justifier les écarts avec le pré-remplissage ?"], defaultCriticality: 'high' },
            '34': { title: "Cas n°34 : Encaissement partiel et annulation d'encaissement", summary: "Gestion des paiements partiels reçus ou effectués, et des annulations d'encaissement.", risk: "Erreur de lettrage, non-conformité des statuts.", impact: "Lettrage comptable, suivi des paiements, e-reporting des statuts.", action: "Mettre en place un processus robuste pour la gestion des encaissements partiels et des annulations, avec mise à jour automatique des statuts de cycle de vie.", checklist: ["Le logiciel comptable gère-t-il les encaissements partiels et les annulations ?", "Les statuts de cycle de vie sont-ils mis à jour en temps réel pour ces opérations ?"], defaultCriticality: 'medium' },
            '35': { title: "Cas n°35 : Notes d'auteur", summary: "Facturation des prestations d'auteurs (soumises à un régime spécifique).", risk: "Non-conformité fiscale (TVA, précompte), erreur de qualification.", impact: "Fiscalité, déclaration sociale, conformité des factures.", action: "S'assurer de la bonne application du régime fiscal et social des notes d'auteur et de la conformité des documents émis/reçus.", checklist: ["Le régime fiscal et social des notes d'auteur est-il correctement appliqué ?", "Les mentions obligatoires spécifiques aux notes d'auteur sont-elles présentes sur les documents ?"], defaultCriticality: 'high' },
            '36': { title: "Cas n°36 : Opérations soumises au secret professionnel et échanges de données sensibles", summary: "Concerne les opérations soumises au secret professionnel (ex: secret bancaire) ou données sensibles.", risk: "Non-conformité RGPD, divulgation d'informations sensibles", impact: "Sanctions légales, atteinte à la réputation", action: "Mettre en place des procédures strictes pour la gestion des données sensibles et vérifier l'utilisation correcte des champs BT-153 et BT-154.", checklist: ["Les procédures de gestion des données sensibles sont-elles à jour ?", "Le personnel est-il formé à l'utilisation des champs spécifiques pour les données sensibles (BT-153/BT-154) ?"], defaultCriticality: 'high' },
            '37': { title: "Cas n°37 : Sociétés en Participation (SEP)", summary: "Votre client est Gérant ou associé d'une Société en Participation (SEP) ou d'un groupement momentané d'entreprises (GME).", risk: "Pré-remplissage TVA erroné, confusion des flux SEP avec les flux propres", impact: "Déclaration de TVA, gestion des écarts, confidentialité de la SEP", action: "Pour les ventes : vérifier l'existence du mandat de facturation si le Gérant crée les factures du Mandataire. Pour les achats : créer une adresse de facturation dédiée (ex: SIRENGérant_gestiontiers). S'assurer que les logiciels isolent correctement les factures de la SEP.", checklist: ["Le Mandataire qui facture le client final est-il identifié ?", "Si le Gérant crée les factures via PA-TE, existe-t-il un mandat de facturation ?", "La plateforme permet-elle au Mandataire d'accéder aux factures émises en son nom ?", "Une adresse de facturation électronique dédiée a-t-elle été créée pour les achats de la SEP ?", "Les logiciels de gestion isolent-ils correctement les factures de la SEP ?", "Le processus de gestion des écarts dans les déclarations de TVA est-il formalisé ?"], defaultCriticality: 'high' },
            '38': { title: "Cas n°38 : Factures avec sous-lignes et regroupements de lignes", summary: "Émission de factures pour des articles composites (kits, packs) ou des regroupements nécessitant des lignes de détail, d'information ou de sous-totaux.", risk: "Incohérence des montants, erreurs de transmission fiscale", impact: "E-invoicing, transmission des données fiscales, conformité des factures", action: "Utiliser impérativement le profil EXTENDED-CTC-FR. Qualifier les lignes avec le sous-type adéquat (DETAIL, INFORMATION, GROUP) et renseigner l'identifiant de ligne Parent (BT-126).", checklist: ["Le logiciel utilise-t-il le profil EXTENDED-CTC-FR pour ces factures ?", "Les lignes sont-elles correctement qualifiées (DETAIL/INFORMATION/GROUP) ?", "L'identifiant de ligne Parent (BT-126) est-il renseigné pour les sous-lignes ?", "Le montant des lignes GROUP est-il cohérent avec la somme des lignes rattachées ?", "Le client est-il informé que les lignes GROUP et INFORMATION ne sont pas transmises au flux fiscal ?"], defaultCriticality: 'medium' },
            '39': { title: "Cas n°39 : Facture Multi-Vendeurs", summary: "Le Vendeur principal regroupe sur une seule facture ses propres prestations et celles d'autres vendeurs tiers pour un même acheteur.", risk: "Non-conformité de la facturation, erreurs dans le flux fiscal", impact: "E-invoicing, transmission des données fiscales, statuts de cycle de vie", action: "Utiliser un cadre de facturation spécifique (BT-23) égal à B8, S8 ou M8. Structurer la facture avec des sous-lignes de type GROUP pour chaque vendeur. La plateforme PA-E doit extraire les flux fiscaux pour chaque facture unitaire.", checklist: ["Le logiciel permet-il d'utiliser les cadres de facturation B8/S8/M8 ?", "La structure avec sous-lignes GROUP est-elle correctement implémentée ?", "La plateforme PA-E extrait-elle les flux fiscaux pour chaque facture unitaire ?", "Les statuts de cycle de vie sont-ils répliqués sur les factures unitaires des vendeurs secondaires ?", "Le processus de transmission des statuts 'Encaissée' est-il en place pour chaque vendeur ?"], defaultCriticality: 'high' },
            '40': { title: "Cas n°40 : Paiements groupés, « Netting » ou Compensation", summary: "Pratique de la compensation (clearing/netting) avec les partenaires, en déduisant le montant des factures de vente du paiement des factures d'achat.", risk: "Fausse le pré-remplissage TVA, double comptabilisation", impact: "TVA, déclaration fiscale, conformité des factures", action: "Établir obligatoirement deux factures distinctes (une dans chaque sens). Renseigner le code moyen de paiement 97 (« Clearing between partners »). Émettre les statuts 'Paiement Transmis' et 'Encaissée' pour chaque facture.", checklist: ["Deux factures distinctes sont-elles établies (une dans chaque sens) ?", "Le code moyen de paiement 97 est-il utilisé dans les factures ?", "Les statuts de cycle de vie sont-ils émis correctement pour chaque facture ?", "Le client comprend-il l'interdiction d'utiliser des lignes négatives en auto-facture ?"], defaultCriticality: 'high' },
            '41': { title: "Cas n°41 : Sociétés de Barter", summary: "Transactions via des sociétés de Barter (troc interentreprises), avec paiement partiel en numéraire (TVA) et compensation en crédits pour le solde.", risk: "Erreur de calcul du net à payer, déclaration de TVA incorrecte", impact: "TVA, suivi des paiements, reporting des encaissements", action: "Utiliser le champ 'Montant déjà payé' (BT-113) pour le montant HT compensé. Transmettre deux blocs dans le statut 'Encaissée' : un encaissement positif du montant TTC et un encaissement négatif du montant HT compensé.", checklist: ["Le champ 'Montant déjà payé' (BT-113) est-il correctement renseigné ?", "Le 'Net à payer' (BT-115) correspond-il au montant en numéraire (TVA) ?", "Le reporting de paiement inclut-il les deux blocs (positif et négatif) ?", "La TVA est-elle payée en totalité en numéraire ?"], defaultCriticality: 'medium' },
            '42': { title: "Cas n°42 : Gestion de la détaxe", summary: "Ventes à des particuliers non-résidents (touristes) donnant lieu à une détaxe (remboursement de TVA).", risk: "Double déclaration ou erreur de TVA, non-conformité fiscale", impact: "Déclaration de TVA, e-reporting, relation avec les opérateurs de détaxe", action: "Cas 1 (gestion directe) : Déclarer en vente B2C (TLB1) puis annuler et créer une écriture en export exonéré (TNT1) après validation du BVE. Cas 2 (vente directe export) : Déclarer en TNT1, corriger en TLB1 si pas de preuve sous 6 mois. Cas 3 (opérateur de détaxe) : Établir une facture B2B à l'opérateur avec cadre B7 (TVA déjà collectée).", checklist: ["Le processus de validation de la détaxe dans les 6 mois est-il en place ?", "Le traitement des écritures (annulation/création) est-il maîtrisé ?", "Si opérateur de détaxe : le cadre de facturation B7 est-il utilisé ?", "La facture de commission de l'opérateur est-elle correctement traitée en B2B ?"], defaultCriticality: 'high' },
            '10_after_emission': { title: "Cas n°10bis : Affacturage après émission de facture", summary: "La décision de céder la créance est prise après l'émission de la facture.", risk: "Risque de paiement au mauvais bénéficiaire, non-conformité des statuts", impact: "Trésorerie, lettrage, conformité réglementaire", action: "Mettre en place un processus de transmission du statut 'Affacturée' (code 225) pour notifier l'acheteur du changement de bénéficiaire.", checklist: ["Le processus de transmission du statut 'Affacturée' est-il en place ?", "Le client est-il informé de la nécessité de mettre en place ce processus ?", "La coordination avec le factor est-elle formalisée ?"], defaultCriticality: 'high' },
            '17b_19a_payment_management': { title: "Cas n°17b/19a bis : Tiers gérant émission ET encaissement", summary: "Un tiers émet les factures au nom du client ET gère également l'encaissement des paiements.", risk: "Confusion sur la responsabilité de l'émission des statuts", impact: "Conformité des statuts, suivi des paiements", action: "Définir clairement qui est responsable de l'émission du statut 'Encaissée' et formaliser le processus.", checklist: ["La responsabilité de l'émission du statut 'Encaissée' est-elle clairement définie ?", "Le processus de coordination entre le tiers et le client est-il formalisé ?", "Le mandat de facturation inclut-il la gestion des statuts ?"], defaultCriticality: 'high' },
            '14_mandataire': { title: "Cas n°14bis : Co-traitance - Client mandataire", summary: "Le client est le mandataire du groupement de co-traitance.", risk: "Obligations spécifiques non respectées", impact: "Conformité réglementaire, responsabilité légale", action: "Mettre en place les processus spécifiques au mandataire : processus de 'visa', production du document récapitulatif, et coordination avec les autres co-traitants.", checklist: ["Le processus de 'visa' des factures des co-traitants est-il en place ?", "La production du document récapitulatif est-elle automatisée ?", "La coordination avec les autres co-traitants est-elle formalisée ?"], defaultCriticality: 'high' },
            'status_management': { title: "Cas n°37 : Gestion des statuts obligatoires", summary: "Gestion de la transmission des statuts de cycle de vie des factures, notamment le statut 'Encaissée' pour les prestations de services et les acomptes.", risk: "Non-conformité réglementaire, sanctions administratives", impact: "Conformité fiscale, suivi des paiements", action: "Définir clairement qui sera responsable de la transmission des statuts obligatoires et mettre en place les processus appropriés.", checklist: ["Qui sera chargé de la transmission du statut 'Encaissée' ?", "Le processus de transmission des statuts est-il automatisé ?", "Les délais de transmission sont-ils respectés ?"], defaultCriticality: 'high' }
        };

        // Display client information
        function displayClientInfo() {
            document.getElementById('dossier-title').textContent = `Dossier de Travail - ${currentClient.name}`;
            
            // Get questionnaire stats
            const venteStats = getQuestionnaireStats('vente');
            const achatStats = getQuestionnaireStats('achat');
            
            const venteComplete = venteStats.answered >= venteStats.total;
            const achatComplete = achatStats.answered >= achatStats.total;
            const venteMissing = venteStats.total - venteStats.answered;
            const achatMissing = achatStats.total - achatStats.answered;
            
            const clientDetails = document.getElementById('client-details');
            clientDetails.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-blue-800 mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2"></i>
                        Informations générales
                    </h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Nom du client</p>
                            <p class="font-semibold text-gray-800">${currentClient.name}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">N° de dossier</p>
                            <p class="font-semibold text-gray-800">${currentClient.dossierNum || 'Non renseigné'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Activité</p>
                            <p class="font-semibold text-gray-800">${currentClient.activity || 'Non renseigné'}</p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">N° SIRET/SIREN</p>
                            <p class="font-semibold text-gray-800">${currentClient.siret || 'Non renseigné'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200">
                    <h4 class="font-semibold text-indigo-800 mb-3 flex items-center">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Avancement des questionnaires
                    </h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Questionnaire Vente</p>
                            <div class="flex items-center mt-1">
                                <div class="flex-1 bg-gray-200 rounded-full h-2.5 mr-3">
                                    <div class="h-2.5 rounded-full ${venteComplete ? 'bg-green-500' : 'bg-orange-500'}" style="width: ${(venteStats.answered / venteStats.total) * 100}%"></div>
                                </div>
                                <span class="font-semibold ${venteComplete ? 'text-green-600' : 'text-red-600'}">${venteStats.answered}/${venteStats.total}</span>
                            </div>
                            ${!venteComplete ? `<p class="text-xs text-red-600 mt-1"><i class="fas fa-exclamation-circle mr-1"></i>${venteMissing} réponse(s) manquante(s)</p>` : '<p class="text-xs text-green-600 mt-1"><i class="fas fa-check-circle mr-1"></i>Questionnaire complet</p>'}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Questionnaire Achat</p>
                            <div class="flex items-center mt-1">
                                <div class="flex-1 bg-gray-200 rounded-full h-2.5 mr-3">
                                    <div class="h-2.5 rounded-full ${achatComplete ? 'bg-green-500' : 'bg-orange-500'}" style="width: ${(achatStats.answered / achatStats.total) * 100}%"></div>
                                </div>
                                <span class="font-semibold ${achatComplete ? 'text-green-600' : 'text-red-600'}">${achatStats.answered}/${achatStats.total}</span>
                            </div>
                            ${!achatComplete ? `<p class="text-xs text-red-600 mt-1"><i class="fas fa-exclamation-circle mr-1"></i>${achatMissing} réponse(s) manquante(s)</p>` : '<p class="text-xs text-green-600 mt-1"><i class="fas fa-check-circle mr-1"></i>Questionnaire complet</p>'}
                        </div>
                    </div>
                </div>
                
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <h4 class="font-semibold text-purple-800 mb-3 flex items-center">
                        <i class="fas fa-server mr-2"></i>
                        Configuration facture électronique
                    </h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">PA sélectionnée</p>
                            <p class="font-semibold ${currentClient.paSelection === 'no' ? 'text-red-600' : 'text-gray-800'}">${currentClient.paSelection === 'yes' ? (currentClient.paName || 'Oui, nom non précisé') : currentClient.paSelection === 'no' ? 'Non' : 'Non renseigné'}</p>
                            ${currentClient.paSelection === 'no' ? '<div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700"><i class="fas fa-exclamation-triangle mr-1"></i>Attention : PA non sélectionnée</div>' : ''}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Niveau d'adresse FE</p>
                            <p class="font-semibold text-gray-800">${getBillingLevelLabel(currentClient.billingLevel)}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h4 class="font-semibold text-green-800 mb-3 flex items-center">
                        <i class="fas fa-laptop mr-2"></i>
                        Logiciels utilisés
                    </h4>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">Logiciel de caisse</p>
                            <p class="font-semibold ${currentClient.caisse === 'no' ? 'text-red-600' : 'text-gray-800'}">${currentClient.caisse === 'yes' ? 'Oui' : currentClient.caisse === 'no' ? 'Non' : currentClient.caisse === 'na' ? 'Non applicable' : 'Non renseigné'}</p>
                            ${currentClient.caisse === 'no' ? '<div class="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs text-red-700"><i class="fas fa-exclamation-triangle mr-1"></i>Attention : Logiciel de caisse non utilisé</div>' : ''}
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Logiciel de facturation</p>
                            <p class="font-semibold text-gray-800">${currentClient.facturation === 'yes' ? 'Oui' : currentClient.facturation === 'no' ? 'Non' : currentClient.facturation === 'na' ? 'Non applicable' : 'Non renseigné'}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <h4 class="font-semibold text-orange-800 mb-3 flex items-center">
                        <i class="fas fa-briefcase mr-2"></i>
                        Mission du cabinet
                    </h4>
                    <div>
                        <p class="text-sm text-gray-600">Gestion facture électronique</p>
                        <p class="font-semibold text-gray-800">${currentClient.delegation === 'cabinet' ? 'Déléguée au cabinet' : currentClient.delegation === 'client' ? 'Par le client' : 'Non renseigné'}</p>
                    </div>
                </div>
            `;
        }

        // Calculate questionnaire statistics (answered vs total)
        function getQuestionnaireStats(wizardType) {
            // Total questions per type
            const totalQuestions = {
                vente: 33, // 33 questions pour le questionnaire vente
                achat: 19  // 19 questions pour le questionnaire achat
            };
            
            const total = totalQuestions[wizardType] || 0;
            let answered = 0;
            
            // Check answers in analyses
            if (currentClient.analyses && currentClient.analyses[wizardType] && currentClient.analyses[wizardType].answers) {
                const answers = currentClient.analyses[wizardType].answers;
                answered = Object.keys(answers).filter(key => {
                    // Only count numeric keys (actual question indices)
                    if (!isNaN(parseInt(key))) {
                        const answer = answers[key];
                        return answer !== null && answer !== undefined && answer !== '';
                    }
                    return false;
                }).length;
            }
            
            // Also check localStorage for wizard answers
            const wizardKey = `wizard_${currentClient.name}_${wizardType}`;
            try {
                const wizardAnswers = localStorage.getItem(wizardKey);
                if (wizardAnswers) {
                    const parsedAnswers = JSON.parse(wizardAnswers);
                    if (Array.isArray(parsedAnswers)) {
                        const wizardAnsweredCount = parsedAnswers.filter((answer, index) => {
                            return answer !== null && answer !== undefined && answer !== '';
                        }).length;
                        answered = Math.max(answered, wizardAnsweredCount);
                    } else if (typeof parsedAnswers === 'object') {
                        const wizardAnsweredCount = Object.keys(parsedAnswers).filter(key => {
                            if (!isNaN(parseInt(key))) {
                                const answer = parsedAnswers[key];
                                return answer !== null && answer !== undefined && answer !== '';
                            }
                            return false;
                        }).length;
                        answered = Math.max(answered, wizardAnsweredCount);
                    }
                }
            } catch (error) {
                console.error('Erreur lors de la lecture des réponses wizard:', error);
            }
            
            return { answered, total };
        }

        // Display analysis options
        function displayAnalysisOptions() {
            const analysisButtons = document.getElementById('analysis-buttons');
            let html = '';
            
            // Check if analyses exist
            if (currentClient.analyses) {
                Object.keys(currentClient.analyses).forEach(analysisType => {
                    const analysis = currentClient.analyses[analysisType];
                    const isCompleted = analysis && analysis.completed;
                    const isCurrentlySelected = currentAnalysis && currentAnalysis === analysis;
                    
                    // Get questionnaire stats
                    const stats = getQuestionnaireStats(analysisType);
                    const isFullyCompleted = stats.answered >= stats.total;
                    const hasMissingAnswers = stats.answered < stats.total;
                    
                    let buttonClass = 'bg-blue-600 hover:bg-blue-700';
                    let icon = 'fa-play-circle';
                    let statusText = '';
                    let statsHtml = '';
                    
                    if (isCompleted) {
                        if (isFullyCompleted) {
                            buttonClass = 'bg-green-600 hover:bg-green-700';
                            icon = 'fa-check-circle';
                            statusText = '(Terminée)';
                            statsHtml = `<span class="ml-2 text-xs bg-green-500 px-2 py-0.5 rounded-full">${stats.answered}/${stats.total}</span>`;
                        } else {
                            buttonClass = 'bg-orange-600 hover:bg-orange-700';
                            icon = 'fa-exclamation-circle';
                            statusText = '(Incomplète)';
                            statsHtml = `<span class="ml-2 text-xs bg-red-500 px-2 py-0.5 rounded-full animate-pulse">${stats.answered}/${stats.total}</span>`;
                        }
                        
                        if (isCurrentlySelected) {
                            buttonClass = isFullyCompleted ? 'bg-green-700 ring-2 ring-green-300 ring-offset-2' : 'bg-orange-700 ring-2 ring-orange-300 ring-offset-2';
                        }
                    } else {
                        if (isCurrentlySelected) {
                            buttonClass = 'bg-blue-700 ring-2 ring-blue-300 ring-offset-2';
                        }
                        if (stats.answered > 0) {
                            statsHtml = `<span class="ml-2 text-xs bg-red-500 px-2 py-0.5 rounded-full animate-pulse">${stats.answered}/${stats.total}</span>`;
                        }
                    }
                    
                    const analysisLabel = analysisType === 'vente' ? 'Vente' : 'Achat';
                    const analysisIcon = analysisType === 'vente' ? 'fa-arrow-up' : 'fa-arrow-down';
                    
                    html += `
                        <button onclick="showAnalysis('${analysisType}')" class="${buttonClass} text-white px-6 py-3 rounded-lg shadow-md transition-all duration-200 ${isCurrentlySelected ? 'transform scale-105' : ''}">
                            <i class="fas ${icon} mr-2"></i>
                            <i class="fas ${analysisIcon} mr-2"></i>
                            Analyse des flux ${analysisLabel}
                            ${statsHtml}
                            ${statusText ? `<span class="ml-2 text-sm opacity-90">${statusText}</span>` : ''}
                        </button>
                    `;
                });
            }
            
            // Add buttons to start new analyses with stats
            if (!currentClient.analyses || !currentClient.analyses.vente) {
                const venteStats = getQuestionnaireStats('vente');
                const venteStatsHtml = venteStats.answered > 0 
                    ? `<span class="ml-2 text-xs bg-red-500 px-2 py-0.5 rounded-full animate-pulse">${venteStats.answered}/${venteStats.total}</span>` 
                    : `<span class="ml-2 text-xs bg-gray-500 px-2 py-0.5 rounded-full">0/${venteStats.total}</span>`;
                html += `
                    <button onclick="startAnalysis('vente')" class="bg-purple-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-purple-700 transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i> 
                        <i class="fas fa-arrow-up mr-2"></i>
                        Démarrer l'analyse de vente
                        ${venteStatsHtml}
                    </button>
                `;
            }
            
            if (!currentClient.analyses || !currentClient.analyses.achat) {
                const achatStats = getQuestionnaireStats('achat');
                const achatStatsHtml = achatStats.answered > 0 
                    ? `<span class="ml-2 text-xs bg-red-500 px-2 py-0.5 rounded-full animate-pulse">${achatStats.answered}/${achatStats.total}</span>` 
                    : `<span class="ml-2 text-xs bg-gray-500 px-2 py-0.5 rounded-full">0/${achatStats.total}</span>`;
                html += `
                    <button onclick="startAnalysis('achat')" class="bg-orange-600 text-white px-6 py-3 rounded-lg shadow-md hover:bg-orange-700 transition-all duration-200">
                        <i class="fas fa-plus mr-2"></i> 
                        <i class="fas fa-arrow-down mr-2"></i>
                        Démarrer l'analyse d'achat
                        ${achatStatsHtml}
                    </button>
                `;
            }
            
            analysisButtons.innerHTML = html;
        }

        // Show analysis results
        function showAnalysis(analysisType) {
            if (!currentClient.analyses || !currentClient.analyses[analysisType]) {
                return;
            }
            
            currentAnalysis = currentClient.analyses[analysisType];
            currentAnalysisType = analysisType;
            
            const analysisResults = document.getElementById('analysis-results');
            const analysisTypeBadge = document.getElementById('analysis-type-badge');
            const analysisTypeTitle = document.getElementById('analysis-type-title');
            const analysisInfoBanner = document.getElementById('analysis-info-banner');
            const casesContainer = document.getElementById('cases-container');
            
            // Update title with flux type
            const fluxLabel = analysisType === 'vente' ? 'du flux de vente' : 'du flux d\'achat';
            analysisTypeTitle.textContent = fluxLabel;
            
            analysisTypeBadge.textContent = `Flux ${analysisType}`;
            
            // Update information banner with clear messaging
            const otherAnalysisType = analysisType === 'vente' ? 'achat' : 'vente';
            const hasOtherAnalysis = currentClient.analyses && currentClient.analyses[otherAnalysisType] && currentClient.analyses[otherAnalysisType].completed;
            
            let bannerClass = 'bg-blue-50 border-blue-400';
            let bannerIcon = 'fas fa-info-circle';
            let bannerText = '';
            
            if (analysisType === 'vente') {
                bannerClass = 'bg-green-50 border-green-400';
                bannerIcon = 'fas fa-arrow-up';
                bannerText = `Vous avez sélectionné le résultat d'analyse du cycle <strong>vente</strong>`;
            } else {
                bannerClass = 'bg-orange-50 border-orange-400';
                bannerIcon = 'fas fa-arrow-down';
                bannerText = `Vous avez sélectionné le résultat d'analyse du cycle <strong>achat</strong>`;
            }
            
            if (hasOtherAnalysis) {
                bannerText += `. Vous pouvez cliquer sur "Analyse des flux ${otherAnalysisType}" pour visualiser l'autre résultat d'analyse.`;
            } else {
                bannerText += `. Cliquez sur "Démarrer l'analyse de ${otherAnalysisType}" pour analyser l'autre cycle.`;
            }
            
                         analysisInfoBanner.className = `${bannerClass} mb-6 p-6 rounded-lg border-l-4 shadow-sm`;
             analysisInfoBanner.innerHTML = `
                 <div class="flex items-start space-x-4">
                     <div class="flex-shrink-0">
                         <i class="${bannerIcon} text-2xl ${analysisType === 'vente' ? 'text-green-600' : 'text-orange-600'}"></i>
                     </div>
                     <div class="flex-1">
                         <p class="text-lg text-gray-800 font-semibold leading-relaxed">${bannerText}</p>
                         <div class="mt-3 p-3 bg-white bg-opacity-50 rounded-lg border border-gray-200">
                             <div class="flex items-center justify-between text-sm">
                                 <span class="flex items-center text-gray-700">
                                     <i class="fas fa-calendar-alt mr-2 text-blue-500"></i>
                                     <strong>Date d'analyse :</strong> 
                                     <span class="ml-1 font-semibold text-gray-800">${new Date(currentAnalysis.date).toLocaleDateString('fr-FR')}</span>
                                 </span>
                                 <span class="flex items-center text-gray-700">
                                     <i class="fas fa-list-check mr-2 text-green-500"></i>
                                     <strong>Cas identifiés :</strong> 
                                     <span class="ml-1 font-semibold text-gray-800">${currentAnalysis.identifiedCases ? currentAnalysis.identifiedCases.length : 0}</span>
                                 </span>
                             </div>
                         </div>
                     </div>
                 </div>
             `;
            
            // Display identified cases
            let html = '';
            if (currentAnalysis.identifiedCases && currentAnalysis.identifiedCases.length > 0) {
                currentAnalysis.identifiedCases.forEach((caseId, index) => {
                    const useCase = useCases[caseId];
                    if (useCase) {
                        const criticalityClass = getCriticalityClass(useCase.defaultCriticality);
                        const criticalityLabel = getCriticalityLabel(useCase.defaultCriticality);
                        const criticalityBadgeClass = getCriticalityBadgeClass(useCase.defaultCriticality);
                        
                        // Get color for numbered logo based on criticality
                        let logoColor = 'bg-gray-100 text-gray-600';
                        if (useCase.defaultCriticality === 'low') {
                            logoColor = 'bg-green-100 text-green-600';
                        } else if (useCase.defaultCriticality === 'medium') {
                            logoColor = 'bg-orange-100 text-orange-600';
                        } else if (useCase.defaultCriticality === 'high') {
                            logoColor = 'bg-red-100 text-red-600';
                        }
                        
                        // Get saved checklist responses
                        const savedResponses = getSavedChecklistResponses(analysisType, caseId);
                        
                        html += `
                            <div class="border border-gray-200 rounded-lg p-4 ${criticalityClass} relative">
                                <div class="absolute top-2 right-2 flex flex-col items-end space-y-1">
                                    <div class="flex items-center space-x-1">
                                        <span class="text-xs text-gray-600 font-medium">Criticité</span>
                                        <span class="${criticalityBadgeClass} px-2 py-1 rounded text-xs font-medium">
                                            ${criticalityLabel}
                                        </span>
                                    </div>
                                </div>
                                <h4 class="font-semibold text-gray-800 mb-2 pr-16">${useCase.title}</h4>
                                <p class="text-sm text-gray-600 mb-2"><strong>Résumé :</strong> ${useCase.summary}</p>
                                <p class="text-sm text-gray-600 mb-2"><strong>Risque :</strong> ${useCase.risk}</p>
                                <p class="text-sm text-gray-600 mb-2"><strong>Impact :</strong> ${useCase.impact}</p>
                                <p class="text-sm text-gray-600 mb-3"><strong>Action recommandée :</strong> ${useCase.action}</p>
                                
                                <div class="mt-3">
                                    <h5 class="font-medium text-gray-700 mb-2">Checklist :</h5>
                                    <div class="space-y-3">
                                        ${useCase.checklist.map((item, itemIndex) => {
                                            const savedResponse = savedResponses[itemIndex] || {};
                                            const checkedValue = savedResponse.answer || '';
                                            const savedNotes = savedResponse.notes || '';
                                            
                                            return `
                                                <div class="border border-gray-200 rounded-lg p-3 ${checkedValue ? 'bg-blue-50 border-blue-300' : ''}">
                                                    <p class="text-sm text-gray-700 mb-2 font-medium">${item}</p>
                                                    <div class="flex items-center space-x-4 mb-2">
                                                        <label class="flex items-center">
                                                            <input type="radio" name="checklist_${caseId}_${itemIndex}" value="yes" class="mr-2 text-green-600" ${checkedValue === 'yes' ? 'checked' : ''} onchange="saveChecklistResponse('${analysisType}', '${caseId}', ${itemIndex}, 'yes', this)">
                                                            <span class="text-sm ${checkedValue === 'yes' ? 'text-green-700 font-medium' : 'text-gray-600'}">Oui</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="radio" name="checklist_${caseId}_${itemIndex}" value="no" class="mr-2 text-red-600" ${checkedValue === 'no' ? 'checked' : ''} onchange="saveChecklistResponse('${analysisType}', '${caseId}', ${itemIndex}, 'no', this)">
                                                            <span class="text-sm ${checkedValue === 'no' ? 'text-red-700 font-medium' : 'text-gray-600'}">Non</span>
                                                        </label>
                                                        <label class="flex items-center">
                                                            <input type="radio" name="checklist_${caseId}_${itemIndex}" value="na" class="mr-2 text-gray-600" ${checkedValue === 'na' ? 'checked' : ''} onchange="saveChecklistResponse('${analysisType}', '${caseId}', ${itemIndex}, 'na', this)">
                                                            <span class="text-sm ${checkedValue === 'na' ? 'text-gray-700 font-medium' : 'text-gray-600'}">Non applicable</span>
                                                        </label>
                                                    </div>
                                                    <textarea class="w-full border border-gray-300 rounded px-2 py-1 text-xs ${savedNotes ? 'border-blue-400 bg-blue-50' : ''}" rows="2" placeholder="Notes..." onchange="saveChecklistNotes('${analysisType}', '${caseId}', ${itemIndex}, this.value)">${savedNotes}</textarea>
                                                    ${savedNotes ? '<p class="text-xs text-blue-600 mt-1">✓ Notes sauvegardées</p>' : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes générales :</label>
                                    <textarea class="w-full border border-gray-300 rounded px-3 py-2 text-sm ${getSavedUseCaseNotes(analysisType, caseId) ? 'border-blue-400 bg-blue-50' : ''}" rows="2" placeholder="Ajoutez vos notes..." onchange="saveUseCaseNotes('${analysisType}', '${caseId}', this.value)">${getSavedUseCaseNotes(analysisType, caseId)}</textarea>
                                    ${getSavedUseCaseNotes(analysisType, caseId) ? '<p class="text-xs text-blue-600 mt-1">✓ Notes générales sauvegardées</p>' : ''}
                                </div>
                            </div>
                        `;
                    }
                });
            } else {
                html = '<p class="text-center text-gray-500 py-8">Aucun cas d\'usage identifié pour cette analyse.</p>';
            }
            
            casesContainer.innerHTML = html;
            analysisResults.classList.remove('hidden');
            
            // Update button display to show which analysis is currently selected
            displayAnalysisOptions();
        }

        // Start new analysis
        function startAnalysis(analysisType) {
            window.location.href = `wizard.html?client=${encodeURIComponent(currentClient.name)}&type=${analysisType}`;
        }

        // Generate reports
        function generateReports() {
            if (!currentClient.analyses || Object.keys(currentClient.analyses).length === 0) {
                alert('Aucune analyse n\'a été effectuée pour ce client.');
                return;
            }
            
            window.location.href = `report-selection.html?client=${currentClient.id}`;
        }

        // Helper functions
        function getStatusLabel(status) {
            const labels = {
                'en_cours': 'En cours',
                'termine': 'Terminé',
                'archive': 'Archivé'
            };
            return labels[status] || 'En cours';
        }

                 function getCriticalityClass(criticality) {
             const classes = {
                 'low': 'bg-green-50 border-green-200',
                 'medium': 'bg-yellow-50 border-yellow-200',
                 'high': 'bg-red-50 border-red-200'
             };
             return classes[criticality] || classes['medium'];
         }
         
         function getCriticalityLabel(criticality) {
             const labels = {
                 'low': 'Faible',
                 'medium': 'Moyenne',
                 'high': 'Élevée'
             };
             return labels[criticality] || labels['medium'];
         }
         
         function getCriticalityBadgeClass(criticality) {
             const classes = {
                 'low': 'bg-green-100 text-green-800',
                 'medium': 'bg-yellow-100 text-yellow-800',
                 'high': 'bg-red-100 text-red-800'
             };
             return classes[criticality] || classes['medium'];
         }

                 // Auto-display analysis results if available
         function autoDisplayAnalysisResults() {
             if (!currentClient.analyses) {
                 return;
             }
             
             // Find the first completed analysis to display
             const completedAnalyses = Object.keys(currentClient.analyses).filter(type => 
                 currentClient.analyses[type] && currentClient.analyses[type].completed
             );
             
             if (completedAnalyses.length > 0) {
                 // Display the first completed analysis
                 showAnalysis(completedAnalyses[0]);
             }
         }
         
         // Save checklist response (Oui/Non/Non applicable)
         function saveChecklistResponse(analysisType, caseId, itemIndex, answer, element) {
             if (!currentClient.analyses || !currentClient.analyses[analysisType]) {
                 console.log('No analysis found for type:', analysisType);
                 return;
             }
             
             // Initialize checklist responses if not exists
             if (!currentClient.analyses[analysisType].checklistResponses) {
                 currentClient.analyses[analysisType].checklistResponses = {};
             }
             if (!currentClient.analyses[analysisType].checklistResponses[caseId]) {
                 currentClient.analyses[analysisType].checklistResponses[caseId] = {};
             }
             if (!currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex]) {
                 currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex] = {};
             }
             
             // Save the answer
             currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex].answer = answer;
             
             console.log('Saving checklist response:', { analysisType, caseId, itemIndex, answer });
             
             // Save to localStorage
             saveClientData();
         }
         
         // Save checklist notes
         function saveChecklistNotes(analysisType, caseId, itemIndex, notes) {
             if (!currentClient.analyses || !currentClient.analyses[analysisType]) {
                 console.log('No analysis found for type:', analysisType);
                 return;
             }
             
             // Initialize checklist responses if not exists
             if (!currentClient.analyses[analysisType].checklistResponses) {
                 currentClient.analyses[analysisType].checklistResponses = {};
             }
             if (!currentClient.analyses[analysisType].checklistResponses[caseId]) {
                 currentClient.analyses[analysisType].checklistResponses[caseId] = {};
             }
             if (!currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex]) {
                 currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex] = {};
             }
             
             // Save the notes
             currentClient.analyses[analysisType].checklistResponses[caseId][itemIndex].notes = notes;
             
             console.log('Saving checklist notes:', { analysisType, caseId, itemIndex, notes });
             
             // Save to localStorage
             saveClientData();
         }
         
         // Save use case notes
         function saveUseCaseNotes(analysisType, caseId, notes) {
             if (!currentClient.analyses || !currentClient.analyses[analysisType]) {
                 console.log('No analysis found for type:', analysisType);
                 return;
             }
             
             // Initialize use case notes if not exists
             if (!currentClient.analyses[analysisType].useCaseNotes) {
                 currentClient.analyses[analysisType].useCaseNotes = {};
             }
             
             // Save the notes
             currentClient.analyses[analysisType].useCaseNotes[caseId] = notes;
             
             console.log('Saving use case notes:', { analysisType, caseId, notes });
             
             // Save to localStorage
             saveClientData();
         }
         
         // Get saved checklist responses
         function getSavedChecklistResponses(analysisType, caseId) {
             if (!currentClient.analyses || !currentClient.analyses[analysisType] || !currentClient.analyses[analysisType].checklistResponses) {
                 return {};
             }
             return currentClient.analyses[analysisType].checklistResponses[caseId] || {};
         }
         
         // Get saved use case notes
         function getSavedUseCaseNotes(analysisType, caseId) {
             if (!currentClient.analyses || !currentClient.analyses[analysisType] || !currentClient.analyses[analysisType].useCaseNotes) {
                 return '';
             }
             return currentClient.analyses[analysisType].useCaseNotes[caseId] || '';
         }
         
         // Helper function to get billing level label
         function getBillingLevelLabel(billingLevel) {
             const labels = {
                 'company': 'Niveau Entreprise (SIREN)',
                 'establishment': 'Niveau Établissement (SIRET)',
                 'custom': 'Niveau Personnalisé (Suffixe)'
             };
             return labels[billingLevel] || 'Non renseigné';
         }
         
         // Save client data to localStorage
         function saveClientData() {
             if (!currentClient) {
                 console.log('No current client to save');
                 return;
             }
             
             // Load existing clients
             const clients = JSON.parse(localStorage.getItem('clients') || '[]');
             
             // Find and update the current client
             const clientIndex = clients.findIndex(c => c.id === currentClient.id);
             if (clientIndex !== -1) {
                 clients[clientIndex] = currentClient;
                 console.log('Updated existing client:', currentClient.id);
             } else {
                 clients.push(currentClient);
                 console.log('Added new client:', currentClient.id);
             }
             
             // Save back to localStorage
             localStorage.setItem('clients', JSON.stringify(clients));
             
             console.log('Client data saved successfully');
         }
         
         // Toggle wizard menu
         function toggleWizardMenu() {
             const menu = document.getElementById('wizard-menu');
             menu.classList.toggle('hidden');
         }
         
         // Close wizard menu when clicking outside
         document.addEventListener('click', function(event) {
             const menu = document.getElementById('wizard-menu');
             const button = event.target.closest('button[onclick="toggleWizardMenu()"]');
             
             if (!button && !menu.contains(event.target)) {
                 menu.classList.add('hidden');
             }
         });
         
         // Return to wizard with existing answers
         function returnToWizard(analysisType) {
             if (!currentClient) {
                 console.error('Aucun client chargé');
                 return;
             }
             
             // Close the menu
             document.getElementById('wizard-menu').classList.add('hidden');
             
             // Prepare answers to pass to wizard
             let answers = [];
             if (currentClient.analyses && currentClient.analyses[analysisType] && currentClient.analyses[analysisType].answers) {
                 answers = currentClient.analyses[analysisType].answers;
             }
             
             // Redirect to wizard with existing answers
             const wizardUrl = `wizard.html?client=${encodeURIComponent(currentClient.name)}&type=${analysisType}&answers=${encodeURIComponent(JSON.stringify(answers))}`;
             window.location.href = wizardUrl;
         }
         
         // Initialize when page loads
         document.addEventListener('DOMContentLoaded', initializeDossier);
         
         // Reload client data when page becomes visible (e.g., when returning from another page)
         document.addEventListener('visibilitychange', function() {
             if (!document.hidden && currentClient) {
                 reloadClientData(currentClient.id);
             }
         });
         
         // Also reload when window gains focus
         window.addEventListener('focus', function() {
             if (currentClient) {
                 reloadClientData(currentClient.id);
             }
         });
    </script>
</body>
</html>